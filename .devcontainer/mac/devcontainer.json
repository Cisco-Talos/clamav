//devcontainer.json
{
    "name": "ClamAV Debian Development Container",
    "build": {
        "dockerfile": "Dockerfile",
        // Context must be the relative path to the project root
        // project/.devcontainer/mac
        "context": "../..",
        // "noCache": true,
        "args": {
            "CLAMAV_TAG_OR_BRANCH": "clamav-1.4.1",
            "REMOTE_USER": "${localEnv:USER}",
            "REMOTE_UID": "${localEnv:UID}",
            "REMOTE_GID": "${localEnv:GID}"
        },
        "options": [
            "--ssh=default"
        ],
        "sshAgentForwarding": true, // Enable SSH agent forwarding
        "remoteUser": "${localEnv:USER}"
    },
    "postCreateCommand": "echo 'Welcome to your Talos AV development container!'",
    "postStartCommand": "git config --global --add safe.directory ${containerWorkspaceFolder}",
    // "postCreateCommand": "cargo build --release && target/release/talosav",
    "mounts": [
        "source=${localEnv:HOME}${localEnv:USERPROFILE}/data/cvd,target=/var/lib/clamav,type=bind,consistency=cached",
        "source=/run/host-services/ssh-auth.sock,target=/run/host-services/ssh-auth.sock,type=bind",
        // "source=${localWorkspaceFolder}/data/kafka_secrets,target=/etc/kafka/secrets,type=bind,consistency=cached",
        // Mounting local rust crate directory to container so that it can be used for development
        // "source=/home/<username>/tcfa/talos-tcfa-clavier,target=/workspace/clavier,type=bind"
    ],
    "runArgs": [
        "--cap-add=SYS_PTRACE",
        "--security-opt",
        "seccomp=unconfined",
        // Mount the SSH agent socket
        // "--mount=type=bind,src=${localEnv:SSH_AUTH_SOCK},target=/ssh-agent.sock",
        // Set the SSH_AUTH_SOCK environment variable
        //"-e",
        //"SSH_AUTH_SOCK=/ssh-agent.sock",
        // Add host.docker.internal to /etc/hosts to enable container to reach host machine so that it can reach test Kafka broker running in docker on host machine
        "--add-host=host.docker.internal:host-gateway"
    ],
    "customizations": {
        "vscode": {
            "extensions": [
                "rust-lang.rust-analyzer",
                "ms-azuretools.vscode-docker",
                "eamodio.gitlens",
                "vadimcn.vscode-lldb",
                "webfreak.debug",
                "ms-vscode-remote.remote-containers"
            ],
            "settings": {
                "terminal.integrated.shell.linux": "/bin/bash"
            }
        }
    }
}